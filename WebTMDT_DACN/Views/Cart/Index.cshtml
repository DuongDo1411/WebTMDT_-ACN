@using WebTMDT_DACN.Models.ViewModels
@model CartItemViewModel
@{
    ViewData["Title"] = "Giỏ Hàng";
    int productCount = Model.CartItems.Sum(item => item.Quantity); // Đếm tổng số lượng sản phẩm
}

<style>
    .cart-page-section {
        background: #f9f9f9;
        padding: 40px 0;
    }

    .cart-header {
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
        margin-top: 0;
        margin-bottom: 20px;
    }

    .cart-list {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        padding: 15px;
    }

    .cart-item-card {
        display: flex;
        align-items: center;
        padding: 20px 10px;
        border-bottom: 1px solid #f0f0f0;
    }

        .cart-item-card:last-child {
            border-bottom: none;
        }

    .cart-item-image {
        width: 100px;
        margin-right: 20px;
    }

        .cart-item-image img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
        }

    .cart-item-details {
        flex-grow: 1;
        padding-right: 15px;
    }

        .cart-item-details h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 0 0 5px 0;
        }

            .cart-item-details h4 a:hover {
                color: var(--primary-color);
            }

        .cart-item-details .price {
            font-size: 1rem;
            color: #555;
            font-weight: 600;
            margin: 0;
        }

    .cart-item-quantity {
        width: 120px;
        margin-right: 15px;
    }

    .quantity-control {
        display: flex;
        width: 120px;
    }

        .quantity-control .btn {
            background: #f0f0f0;
            border: 1px solid #e0e0e0;
            border-radius: 0;
            font-weight: 700;
            color: #555;
        }

            .quantity-control .btn:first-child {
                border-radius: 3px 0 0 3px;
            }

            .quantity-control .btn:last-child {
                border-radius: 0 3px 3px 0;
            }

            .quantity-control .btn:hover {
                background: #ddd;
            }

        .quantity-control input {
            text-align: center;
            border: 1px solid #e0e0e0;
            border-left: none;
            border-right: none;
            border-radius: 0;
            box-shadow: none;
            padding: 6px;
            font-size: 1rem;
        }

    .cart-item-total {
        width: 120px;
        text-align: right;
        margin-right: 15px;
    }

        .cart-item-total .total-price {
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: 700;
            margin: 0;
        }

    .cart-item-remove {
        width: 30px;
        text-align: center;
    }

        .cart-item-remove a {
            font-size: 1.5rem;
            color: #d9534f;
        }

            .cart-item-remove a:hover {
                color: #c9302c;
            }

    .clear-cart-btn {
        margin-top: 15px;
    }

    /* --- CSS CHO CỘT BÊN PHẢI --- */

    /* Box Tóm Tắt (Giữ nguyên) */
    .cart-summary-box {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        padding: 30px;
    }

        .cart-summary-box h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .cart-summary-box .total-line {
            display: flex;
            justify-content: space-between;
            font-size: 1.1rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 15px;
        }

        .cart-summary-box .grand-total-line {
            display: flex;
            justify-content: space-between;
            font-size: 1.3rem;
            font-weight: 700;
            margin-top: 20px;
        }

            .cart-summary-box .grand-total-line .total-price {
                color: var(--primary-color);
            }

    /* Công cụ tính ship */
    .shipping-calculator {
        border-top: 1px solid #f0f0f0;
        padding-top: 20px;
    }

        .shipping-calculator p {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .shipping-calculator .form-control {
            margin-bottom: 10px;
        }

    .btn-calculate-shipping {
        margin-top: 10px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        font-weight: 600;
        color: #555;
    }

        .btn-calculate-shipping:hover {
            background: #ddd;
            color: #333;
        }

    /* === CSS MỚI CHO BOX THANH TOÁN === */
    .payment-methods-box {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        padding: 30px;
        margin-top: 20px; /* Tách biệt với box Tóm tắt */
    }

        .payment-methods-box h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 15px;
        }

    /* Thông báo yêu cầu tính ship */
    .payment-notice {
        background: #fef8e5;
        border: 1px solid #fddc88;
        color: #a1803a;
        padding: 15px;
        border-radius: 5px;
        text-align: center;
        font-weight: 600;
    }

        .payment-notice i {
            margin-right: 5px;
        }

    /* CSS cho các nút thanh toán (COD, VNPAY) */
    .btn-payment-option {
        display: block;
        width: 100%;
        text-transform: uppercase;
        font-weight: 700;
        padding: 12px;
        font-size: 1rem;
        margin-top: 10px;
        border: none;
        text-align: center;
    }

    /* Nút VNPAY (Copy từ code của bạn) */
    .btn-vnpay {
        background-color: #005A9C;
        color: #ffffff !important;
    }

        .btn-vnpay:hover {
            background-color: #004a80;
            color: #ffffff !important;
        }

    /* Giỏ hàng trống */
    .cart-empty {
        text-align: center;
        padding: 50px;
        background: #fff;
        border-radius: 8px;
    }
</style>

<section id="cart_items" class="cart-page-section">
    <div class="container">
        <div class="breadcrumbs">
            <ol class="breadcrumb">
                <li><a asp-controller="Home" asp-action="Index">Home</a></li>
                <li class="active">Shopping Cart</li>
            </ol>
        </div>

        @if (Model.CartItems.Count > 0)
        {
            <div class="row">
                <div class="col-md-8">
                    <h3 class="cart-header">Giỏ hàng của bạn (@Model.CartItems.Count sản phẩm)</h3>
                    <div class="cart-list">
                        @foreach (var item in Model.CartItems)
                        {
                            <div class="cart-item-card">
                                <div class="cart-item-image">
                                    <a asp-controller="Product" asp-action="Details" asp-route-id="@item.ProductId">
                                        <img src="~/media/products/@item.Image" alt="@item.ProductName">
                                    </a>
                                </div>
                                <div class="cart-item-details">
                                    <h4><a asp-controller="Product" asp-action="Details" asp-route-id="@item.ProductId">@item.ProductName</a></h4>
                                    <p class="price">@item.Price.ToString("#,##0 VNĐ")</p>
                                </div>
                                <div class="cart-item-quantity">
                                    <div class="quantity-control">
                                        <a class="btn btn-default" asp-action="Decrease" asp-controller="Cart" asp-route-id="@item.ProductId"> - </a>
                                        <input class="form-control" type="text" name="quantity" value="@item.Quantity" readonly size="2">
                                        <a class="btn btn-default" asp-action="Increase" asp-controller="Cart" asp-route-id="@item.ProductId"> + </a>
                                    </div>
                                </div>
                                <div class="cart-item-total">
                                    <p class="total-price">@Model.CartItems.Where(x => x.ProductId == item.ProductId).Sum(x => x.Quantity * x.Price).ToString("#,##0 VNĐ")</p>
                                </div>
                                <div class="cart-item-remove">
                                    <a class="cart_quantity_delete" asp-action="Remove" asp-controller="Cart" asp-route-id="@item.ProductId"><i class="fa fa-times-circle"></i></a>
                                </div>
                            </div>
                        }
                    </div>
                    <a class="btn btn-danger clear-cart-btn" asp-controller="Cart" asp-action="Clear">
                        <i class="fa fa-trash-o"></i> Xóa Toàn Bộ Giỏ Hàng
                    </a>
                </div>

                <div class="col-md-4">

                    <div class="cart-summary-box">
                        <h3>Tóm Tắt Giỏ Hàng</h3>

                        <div class="total-line">
                            <span>Tạm tính:</span>
                            <span id="sub-total-price">@Model.SubTotal.ToString("#,##0 VNĐ")</span>
                        </div>

                        <div class="shipping-calculator">
                            <p>Ước tính Phí Vận Chuyển</p>
                            <div class="form-group">
                                <select id="tinh" class="form-control">
                                    <option value="0">Chọn Tỉnh Thành</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <select id="quan" class="form-control">
                                    <option value="0">Chọn Quận Huyện</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <select id="phuong" class="form-control">
                                    <option value="0">Chọn Phường Xã</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-default btn-block btn-calculate-shipping">
                                <i class="fa fa-calculator"></i> Tính Phí Ship
                            </button>
                            <button type="button" class="btn btn-danger btn-block" id="btn-remove-shipping" style="margin-top: 10px;">
                                <i class="fa fa-times"></i> Bỏ chọn vận chuyển
                            </button>
                        </div>

                        <div class="total-line" style="margin-top: 20px;">
                            <span>Phí ship:</span>
                            <span class="total-price" id="shipping-cost-price">@Model.ShippingCost.ToString("#,##0 VNĐ")</span>
                        </div>

                        <div class="grand-total-line">
                            <span>Tổng cộng:</span>
                            <span class="total-price" id="grand-total-price">@Model.GrandToTal.ToString("#,##0 VNĐ")</span>
                        </div>
                    </div>

                    @if (User.Identity?.IsAuthenticated ?? false)
                    {
                        <div class="payment-methods-box">
                            <h3>Phương thức Thanh toán</h3>

                            @if (Model.ShippingCost <= 0)
                            {
                                <div class="payment-notice">
                                    <i class="fa fa-info-circle"></i> Vui lòng tính phí vận chuyển ở trên để chọn phương thức thanh toán.
                                </div>
                            }
                            else
                            {
                                <a class="btn btn-primary btn-payment-option" asp-controller="Checkout" asp-action="Checkout">
                                    <i class="fa fa-truck"></i> Thanh toán khi nhận hàng (COD)
                                </a>

                                <form method="POST" asp-action="CreatePaymentUrlVnpay" asp-controller="Payment">
                                    <input type="hidden" name="Name" value="@User.Identity.Name" />
                                    <input type="hidden" name="Amount" value="@Model.GrandToTal" />
                                    <input type="hidden" name="OrderDescription" value="Thanh toán đơn hàng tại DuongDoStore" />
                                    <input type="hidden" name="OrderType" value="other" />
                                    <button class="btn btn-vnpay btn-payment-option" type="submit">
                                        <i class="fa fa-credit-card"></i> Thanh toán qua VNPAY
                                    </button>
                                </form>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="payment-methods-box">
                            <h3>Thanh toán</h3>
                            <p style="text-align: center; font-size: 1rem; color: #555;">Vui lòng đăng nhập để tiến hành thanh toán.</p>
                            <a class="btn btn-primary" asp-controller="Account" asp-action="Login" style="width: 100%;">
                                <i class="fa fa-lock"></i> Đăng nhập ngay
                            </a>
                        </div>
                    }

                </div>
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-md-12">
                    <div class="cart-empty">
                        <h3>Giỏ hàng của bạn đang trống!</h3>
                        <p>Hãy quay lại trang chủ để bắt đầu mua sắm.</p>
                        <a asp-controller="Home" asp-action="Index" class="btn btn-primary" style="background:var(--primary-color); border:none;">
                            <i class="fa fa-home"></i> Về Trang Chủ
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Khai báo biến toàn cục để lưu trữ dữ liệu địa lý
            var geoData = [];

            // 1. Tải dữ liệu JSON từ máy chủ của bạn
            // (Đảm bảo đường dẫn tới file JSON của bạn là /data/vietnam_location.json)
            $.getJSON('/data/vietnam-provinces.json', function(data) {
                geoData = data;

                // Load Tỉnh/Thành Phố
                $.each(geoData, function (key, tinh) {
                    // CẬP NHẬT: Dùng 'tinh.name' cho cả value và text
                    $("#tinh").append('<option value="' + tinh.name + '">' + tinh.name + '</option>');
                });
            }).fail(function() {
                 // Xử lý lỗi nếu file JSON không tồn tại hoặc không đọc được
                 console.error("Lỗi: Không thể tải dữ liệu địa lý từ file JSON.");
                 Swal.fire("Lỗi tải dữ liệu", "Không thể tải danh sách Tỉnh/Thành. Vui lòng kiểm tra file /wwwroot/data/vietnam_location.json", "error");
            });

            // 2. Xử lý sự kiện khi chọn Tỉnh/Thành
            $("#tinh").change(function(e) {
                var tenTinh = $(this).val(); // Lấy ra tên Tỉnh (vì value giờ là name)

                $("#quan").html('<option value="0">Chọn Quận Huyện</option>');
                $("#phuong").html('<option value="0">Chọn Phường Xã</option>');

                if (tenTinh != "0") {
                    // CẬP NHẬT: Tìm bằng 'tinh.name'
                    var selectedProvince = geoData.find(t => t.name === tenTinh);

                    // CẬP NHẬT: Dùng 'selectedProvince.districts'
                    if (selectedProvince && selectedProvince.districts) {
                        $.each(selectedProvince.districts, function (key, quan) {
                            // CẬP NHẬT: Dùng 'quan.name' cho cả value và text
                            $("#quan").append('<option value="' + quan.name + '">' + quan.name + '</option>');
                        });
                    }
                }
            });

            // 3. Xử lý sự kiện khi chọn Quận/Huyện
            $("#quan").change(function(e) {
                var tenTinh = $("#tinh").val();
                var tenQuan = $(this).val(); // Lấy ra tên Quận

                $("#phuong").html('<option value="0">Chọn Phường Xã</option>');

                if (tenQuan != "0") {
                    // CẬP NHẬT: Tìm Tỉnh bằng 'tinh.name'
                    var selectedProvince = geoData.find(t => t.name === tenTinh);

                    if (selectedProvince && selectedProvince.districts) {
                        // CẬP NHẬT: Tìm Quận bằng 'quan.name'
                        var selectedDistrict = selectedProvince.districts.find(q => q.name === tenQuan);

                        // CẬP NHẬT: Dùng 'selectedDistrict.wards'
                        if (selectedDistrict && selectedDistrict.wards) {
                            $.each(selectedDistrict.wards, function (key, phuong) {
                                // CẬP NHẬT: Dùng 'phuong.name' cho cả value và text
                                $("#phuong").append('<option value="' + phuong.name + '">' + phuong.name + '</option>');
                            });
                        }
                    }
                }
            });


            // --- CÁC SCRIPT CŨ VẪN GIỮ NGUYÊN ---

            // 4. Xử lý nút Tính Phí Ship (Không đổi)
            // Code này đã đúng vì nó lấy .text() (tên) để gửi đi
            $(".btn-calculate-shipping").click(function () {
                var tinh = $("#tinh").find("option:selected").text();
                var quan = $("#quan").find("option:selected").text();
                var phuong = $("#phuong").find("option:selected").text();

                if (tinh == "Chọn Tỉnh Thành" || quan == "Chọn Quận Huyện" || phuong == "Chọn Phường Xã") {
                    Swal.fire("Lỗi", "Vui lòng chọn đầy đủ Tỉnh/Quận/Phường.", "error");
                }
                else {
                    $.ajax({
                        type: "POST",
                        url: "@Url.Action("GetShipping", "Cart")",
                        data: { tinh: tinh, quan: quan, phuong: phuong },
                        success: function (result) {
                            if (result) {
                                Swal.fire({
                                    title: "Đã cập nhật",
                                    text: "Đã cập nhật phí ship. Trang sẽ được tải lại...",
                                    icon: "success",
                                    timer: 2000,
                                    showConfirmButton: false
                                }).then((result) => {
                                    location.reload();
                                });
                            }
                        },
                        error: function () {
                             Swal.fire("Lỗi", "Không tìm thấy phí ship cho khu vực này.", "error");
                        }
                    });
                }
            });

            // 5. Xử lý sự kiện click cho nút Bỏ chọn (Không đổi)
            $("#btn-remove-shipping").click(function () {
                Swal.fire({
                    title: 'Bạn chắc chắn?',
                    text: "Bạn muốn bỏ chọn phí vận chuyển này?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Đồng ý!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            type: "POST",
                            url: "@Url.Action("DeleteShipping", "Cart")",
                            success: function (result) {
                                if (result.success) {
                                    location.reload();
                                }
                            },
                            error: function () {
                                Swal.fire("Đã xảy ra lỗi khi xóa!");
                            }
                        });
                    }
                });
            });

        });
    </script>
}