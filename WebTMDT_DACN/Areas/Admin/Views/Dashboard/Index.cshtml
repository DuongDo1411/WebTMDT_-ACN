@model IEnumerable<BrandModel>
@{
    ViewData["Title"] = "Dashboard";
}

<style>
    /* Thẻ thống kê (Stats Card) */
    .dashboard-stat-card {
        background: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }

        /* Icon bên trái */
        .dashboard-stat-card .stat-icon {
            font-size: 2.5rem; /* Kích thước icon */
            padding: 20px;
            border-radius: 50%;
            color: #fff;
            margin-right: 20px;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Thông tin (Số và chữ) */
        .dashboard-stat-card .stat-info h3 {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0 0 5px 0;
            color: #333;
        }

        .dashboard-stat-card .stat-info p {
            font-size: 1rem;
            color: #777;
            margin: 0;
            font-weight: 600;
            text-transform: uppercase;
        }

    /* Màu sắc cho các thẻ */
    .color-1 .stat-icon {
        background: #00c0ef;
    }

    .color-2 .stat-icon {
        background: #00a65a;
    }

    .color-3 .stat-icon {
        background: #f39c12;
    }

    .color-4 .stat-icon {
        background: #dd4b39;
    }

    /* === CSS MỚI: Căn chỉnh Tiêu đề Panel và Bộ lọc === */
    .panel-heading-with-filter {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .panel-heading-with-filter .panel-title {
            margin: 0; /* Ghi đè margin mặc định */
        }
</style>

<h3>Dashboard</h3>
<hr />

<div class="row">

    <div class="col-md-3 col-sm-6">
        <div class="dashboard-stat-card color-1">
            <div class="stat-icon"><i class="fa fa-product-hunt"></i></div>
            <div class="stat-info">
                <h3>@ViewBag.CountProduct</h3>
                <p>Sản phẩm</p>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="dashboard-stat-card color-2">
            <div class="stat-icon"><i class="fa fa-shopping-cart"></i></div>
            <div class="stat-info">
                <h3>@ViewBag.CountOrder</h3>
                <p>Đơn hàng</p>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="dashboard-stat-card color-3">
            <div class="stat-icon"><i class="fa fa-sitemap"></i></div>
            <div class="stat-info">
                <h3>@ViewBag.CountCategory</h3>
                <p>Danh mục</p>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-sm-6">
        <div class="dashboard-stat-card color-4">
            <div class="stat-icon"><i class="fa fa-users"></i></div>
            <div class="stat-info">
                <h3>@ViewBag.CountUser</h3>
                <p>Người dùng</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">

            <div class="panel-heading panel-heading-with-filter">
                <h3 class="panel-title">
                    <i class="fa fa-chart-line"></i> Thống Kê Doanh Thu
                </h3>

                <select class="form-control filter-select" style="width: 150px;">
                    <option value="7" selected>7 ngày qua</option>
                    <option value="30">1 tháng qua</option>
                    <option value="90">3 tháng qua</option>
                    <option value="365">1 năm qua</option>
                </select>
            </div>

            <div class="panel-body">
                <div id="myfirstchart" style="height: 250px;"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            // 1. Khởi tạo biểu đồ (từ image_9dcc48.png)
            // Biểu đồ được khởi tạo với dữ liệu rỗng (data: [])
            var ChartMorris = new Morris.Line({
                element: 'myfirstchart',
                // Move data processing inside the success callback
                data: [],
                xkey: 'date',
                ykeys: ['sold', 'quantity', 'revenue', 'profit'],
                labels: ["Số lượng bán ra", "Đơn hàng", "Doanh thu", "Lợi nhuận"],
            });

            // 2. Tải dữ liệu ban đầu cho biểu đồ (từ image_9dcc6a.png)
            // Gọi AJAX ngay lập tức để lấy dữ liệu lần đầu
            $.ajax({
                url: "@Url.Action("GetChartData", "Dashboard")",
                type: "POST",
                dataType: "json",
                success: function (data) {
                    if (data) {
                        // Cập nhật dữ liệu cho biểu đồ
                        ChartMorris.setData(data.map(function (item) {
                            return {
                                date: item.date,
                                sold: item.sold,
                                quantity: item.quantity,
                                revenue: item.revenue,
                                profit: item.profit
                            };
                        }));
                    } else {
                        console.warn("No data received for Morris chart update.");
                        ChartMorris.setData([]);
                    }
                },
                error: function (error) {
                    console.error("Error fetching data:", error);
                }
            });

            // 3. Xử lý sự kiện lọc/thay đổi (từ image_9dd00e.jpg và image_9dd395.png)
            // Khi người dùng thay đổi lựa chọn (ví dụ: 7 ngày, 30 ngày)
            $('.filter-select').on('change', function () {
                var days = $(this).val();
                var endDate = new Date();
                var startDate = new Date(endDate.getTime() - days * 24 * 60 * 60 * 1000);
                // alert(startDate);
                // alert(endDate);

                // Gọi AJAX khác để lấy dữ liệu theo bộ lọc
                $.ajax({
                    url: "@Url.Action("GetChartDataBySelect", "Dashboard")",
                    type: 'POST',
                    dataType: "json",
                    data: {
                        startDate: startDate.toISOString().split('T')[0],
                        endDate: endDate.toISOString().split('T')[0]
                    },
                    success: function (data) {
                        if (data) {
                            // Cập nhật lại dữ liệu cho biểu đồ
                            ChartMorris.setData(data.map(function (item) {
                                return {
                                    date: item.date,
                                    sold: item.sold,
                                    quantity: item.quantity,
                                    revenue: item.revenue,
                                    profit: item.profit
                                };
                            }));
                        } else {
                            console.warn("No data received for Morris chart update.");
                            ChartMorris.setData([]);
                        }
                    },
                    error: function (error) {
                        console.error("Error fetching data:", error);
                    }
                });
            });

        });
    </script>
}