@model ShippingModel;
@{
    ViewData["Title"] = "Quản lý Vận chuyển";
    Paginate paper = new Paginate();
    int pageNo = 0;
    if (ViewBag.paper != null)
    {
        paper = ViewBag.paper;
        pageNo = paper.CurrentPage;
    }
}

@* XÓA BỎ CSS TÙY CHỈNH (css_select) VÌ ĐÃ CÓ BOOTSTRAP HỖ TRỢ *@
@* <style type="text/css">
    .css_select_div{ text-align: center;}
    .css_select{ display: inline-table; width: 25%; ...}
</style> *@

@* ============================================= *@
@* KHỐI 1: FORM TẠO SHIPPING *@
@* ============================================= *@
<div class="panel panel-default" style="margin-bottom: 25px;">
    <div class="panel-heading">
        <h3 class="panel-title">TẠO SHIPPING</h3>
    </div>
    <div class="panel-body">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        @* Dùng Bootstrap Grid (row/col) để xếp hàng *@
        <div class="row">
            @* CỘT 1: TỈNH THÀNH *@
            <div class="col-md-3">
                <div class="form-group">
                    <label>Tỉnh Thành</label>
                    @* SỬ DỤNG class="form-control" của Bootstrap *@
                    <select class="form-control" id="tinh" name="tinh" title="Chọn Tỉnh Thành">
                        <option value="0">Chọn Tỉnh Thành</option>
                    </select>
                </div>
            </div>

            @* CỘT 2: QUẬN HUYỆN *@
            <div class="col-md-3">
                <div class="form-group">
                    <label>Quận Huyện</label>
                    <select class="form-control" id="quan" name="quan" title="Chọn Quận Huyện">
                        <option value="0">Chọn Quận Huyện</option>
                    </select>
                </div>
            </div>

            @* CỘT 3: PHƯỜNG XÃ *@
            <div class="col-md-3">
                <div class="form-group">
                    <label>Phường Xã</label>
                    <select class="form-control" id="phuong" name="phuong" title="Chọn Phường Xã">
                        <option value="0">Chọn Phường Xã</option>
                    </select>
                </div>
            </div>

            @* CỘT 4: GIÁ *@
            <div class="col-md-3">
                <div class="form-group">
                    <label>Nhập giá</label>
                    <input asp-for="Price" id="price-shipping" class="form-control" placeholder="Ví dụ: 25000" />
                    <span asp-validation-for="Price" class="text-danger"></span>
                </div>
            </div>
        </div>

        @* Nút Create *@
        <div class="form-group">
            <button type="button" class="btn btn-primary btn-add-shipping">
                <i class="fa fa-plus"></i> Create
            </button>
        </div>
    </div>
</div>


@* ============================================= *@
@* KHỐI 2: BẢNG "SHOPPING LIST" *@
@* ============================================= *@
<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Shopping List</h3>
    </div>
    <div class="panel-body">
        @* Thêm "table-responsive" để bảng không bị vỡ trên di động *@
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="myTable" style="width:100%">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Thành phố</th>
                        <th>Quận</th>
                        <th>Phường</th>
                        <th>Giá</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int i = (paper.CurrentPage - 1) * paper.PageSize + 1;
                    }
                    @foreach (var shipping in ViewBag.Shippings)
                    {
                        <tr>
                            <td>@i</td>
                            <td>@shipping.City</td>
                            <td>@shipping.District</td>
                            <td>@shipping.Ward</td>
                            <td>@shipping.Price.ToString("#,##0 VNĐ")</td>
                            <td>
                                @* SỬA LỖI NHÁY KÉP (dùng nháy đơn bên ngoài) VÀ THÊM ICON *@
                                <a onclick="return confirm('Bạn chắc chắn muốn xóa chứ')"
                                   href="@Url.Action("Delete", "Shipping", new { id = shipping.Id })"
                                   class="btn btn-danger btn-sm">
                                    <i class="fa fa-trash"></i> Delete
                                </a>
                            </td>
                        </tr>
                        { i++; }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<a asp-action="Index" asp-controller="Shipping">Back to List Shippings</a>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    @* PHẦN JAVASCRIPT CỦA BẠN (giữ nguyên không đổi) *@
    <script>
        $(".btn-add-shipping").click(function () {
            var tinh = $("#tinh").find("option:selected").text();
            var quan = $("#quan").find("option:selected").text();
            var phuong = $("#phuong").find("option:selected").text();
            var price = $("#price-shipping").val();
            // alert(tinh);
            // alert(quan);
            // alert(phuong);
            // alert(price);
            if (tinh == "" || quan == "" || phuong == "" || price == "") {
                Swal.fire("Vui lòng không bỏ trống.");
            }
            else {
                $.ajax({
                    type: "POST",
                    url: "@Url.Action("StoreShipping", "Shipping")",
                    data: { tinh: tinh, quan: quan, phuong: phuong, price: price }, // Send data to the server
                    success: function (result) {
                        // Handle successful update
                        if (result.success) {
                            Swal.fire({
                                title: "Thành công!",
                                text: "Thêm vận chuyển thành công.",
                                icon: "success"
                            }).then((result) => {
                                // Tự động load lại trang sau khi thêm thành công
                                location.reload();
                            });
                        }
                        else if (result.duplicate) {
                            Swal.fire("Lỗi!", "Dữ liệu bị trùng lặp.", "error");
                        }
                    }
                });
            }
        });
        $(document).ready(function() {
            //Lấy tỉnh thành
            $.getJSON('https://esgoo.net/api-tinhthanh/1/0.htm',function(data_tinh){
                if(data_tinh.error==0){
                    $.each(data_tinh.data, function (key_tinh,val_tinh) {
                        $("#tinh").append('<option value="'+val_tinh.id+'">'+val_tinh.full_name+'</option>');
                    });
                    $("#tinh").change(function(e){
                        var idtinh=$(this).val();
                        //Lấy quận huyện
                        $.getJSON('https://esgoo.net/api-tinhthanh/2/'+idtinh+'.htm',function(data_quan){
                            if(data_quan.error==0){
                                $("#quan").html('<option value="0">Quận Huyện</option>');
                                $("#phuong").html('<option value="0">Phường Xã</option>');
                                $.each(data_quan.data, function (key_quan,val_quan) {
                                    $("#quan").append('<option value="'+val_quan.id+'">'+val_quan.full_name+'</option>');
                                });
                                //Lấy phường xã
                                $("#quan").change(function(e){
                                    var idquan=$(this).val();
                                    $.getJSON('https://esgoo.net/api-tinhthanh/3/'+idquan+'.htm',function(data_phuong){
                                        if(data_phuong.error==0){
                                            $("#phuong").html('<option value="0">Phường Xã</option>');
                                            $.each(data_phuong.data, function (key_phuong,val_phuong) {
                                                $("#phuong").append('<option value="'+val_phuong.id+'">'+val_phuong.full_name+'</option>');
                                            });
                                        }
                                    });
                                });

                            }
                        });
                    });

                }
            });
        });
    </script>
}